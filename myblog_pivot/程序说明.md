# 环境配置

- win10	Goland
- Go 1.16.2
- Beego 2.0
- Mysql 8.0.23 
- Redis 3.2.100

# 文件目录

```
│  go.mod
│  go.sum
│  lastupdate.tmp
│  list.txt
│  main.go
│  myblog.exe
│  程序说明.md
│  
│      
├─conf
│      app.conf
│      
├─controllers
│      base.go
│      comment.go
│      default.go
│      posts.go
│      user.go
│      
├─models
│      comment.go
│      page.go
│      posts.go
│      redis.go
│      user.go
│      validation.go
│      
├─routers
│      router.go
│      
├─utils
│      email.go
│      GetMd5.go
│      token.go
│      
└─压力测试数据
        summary_100.csv
        summary_1000.csv
        summary_noredis_100.csv
        summary_noredis_1000.csv
        
```



# conf

```go
appname = myblog
httpport = 8080
runmode = dev
autorender = false
copyrequestbody = true
EnableDocs = true

drivername = mysql
username = root
password = 123456
host = 127.0.0.1
port = 3306
database = blog
pagesize = 10
commentListPageNum = 10
postListPageNum = 10
sessionon = true


redisHost = "127.0.0.1"
redisPort = "6379"
redisPass = "123456"
redisDB = 0
redisPrefix = "UIMS_PERMISSION_"
```

注意要开启mysql,redis服务才能运行。

# 结构体

```go
//分页返回结构体
type Page struct {
   PagePosts    []Post    `json:"Posts,omitempty"`
   PageComments []Comment `json:"Comments,omitempty"`
   AllNum      int  //帖子或者评论总数
   CurrentPage  int //当前页码
   PrePage      int  //前一页
   NextPage     int  //后一页
   HasPrePage   bool //是否有前一页
   HasNextPage  bool
}



//单条评论
type Comment struct {
	Id int `orm:"pk;auto"`
	Content string `orm:"size(4000);description(评论内容)"`
	PostId int `orm:"description(帖子编号)"`  //属于哪个帖子
	AuthorId int
	AuthorName string
	CreateTime time.Time `orm:"auto_now_add;type(datetime);description(创建时间)"`
}

//单个帖子
type Post struct {
	Id    int `orm:"pk;auto"`
	Title string `orm:"description(帖子标题)"`
	Content string `orm:"size(4000);description(帖子内容)"`
	AuthorId int `orm:"description(帖子作者)"`
	AuthorName string
	NumPosts int //用户有几篇文章
	CreateTime time.Time `orm:"auto_now_add;type(datetime);description(创建时间)"`
}

//用户
type User struct {
	Id         int `orm:"pk;auto"`
	Username   string
	Password   string
	Status int //0表示已注册但未验证	1表示已经注册且已经验证
	Email string
	Createtime int64 `orm:"auto_now_add;type(datetime);description(创建时间)"`
}

//验证码
type validation struct {
	email string
	code string
}

```

#     注册的路由

```go
   beego.Router("/", &controllers.MainController{})
//post(贴子的意思，不是请求方法)  
//方法 post 增加帖子
//方法 delete  删除特定帖子
//方法 put 更新帖子
beego.Router("/post/", &controllers.PostController{}) 
//分页返回帖子
beego.Router("/post/page", &controllers.PostController{},"get:GetAllPages")
//分页返回特定用户的帖子
beego.Router("/post/pageanduser", &controllers.PostController{},"get:GetAllUserPages")


//comment评论
//方法  get  获取某条帖子的评论 
//方法  post 提交某条帖子评论
//方法  put  更新某条具体评论
//方法  delete  删除某条评论
beego.Router("/comment/", &controllers.CommentController{})



//用户注册
beego.Router("/user/register", &controllers.UserController{},"post:Register")
//用户登录
beego.Router("/user/login", &controllers.UserController{},"post:Login")
//用户修改密码
beego.Router("/user/editpass", &controllers.UserController{},"post:EditPassword")
//用户验证码
beego.Router("/user/verify", &controllers.UserController{},"post:VerifyCode")


//base.go
//该方法在所有路由执行前会首先执行,判断用户是否登录。
//不登录只能使用查询功能。
func (c *BaseController) Prepare()
```





# models 

## comment.go

```go
//根据具体的评论ID查找评论
func FindCommentWithId(commentid int) (Comment,error) 
//根据页码和帖子ID查找评论
func FindCommentWithPageAndPostid(page int, postid int) (Page,error) 

```

## page.go

```go
//根据页码查找所有该页帖子，实现分页返回
func FindPostWithPage(page int) (Page, error) 
//根据页码查找该用户的所有该页帖子，实现分页返回
func FindPostWithPageAndUser(page int, author_id int) (Page, error) 
```

## posts.go

```go
//根据贴子ID 查找单个帖子
func FindPostWithId(postid int) (Post, error)
```

## redis.go

```go
//初始化
func init()
//初始化缓存数据
func InitPermissionRedisData() 
//清除相关redis数据
func clearPermissionData(redisConn redis.Conn)
//设置key value缓存
func SetRedisKeyValue(key, value string)
//设置过期时间
func SetExpireTime(key string, time int64)
//删除单个key值
func DelRedisKey(key string) 
//获得value值
func GetRedisValue(key string) (interface{},error) 
```

# utils

## email.go

```go
//发送邮件
func SendMail(mailTo string, subject string, body string) error
```

## GetMd5.go

```go
//MD5加密
func GetMd5(pwd string) string
```



## token.go

```go
//验证jtw token
func ValidateToken(tokenString string) (info User, err error)
//获取jwt token
func GenerateToken(info *User, expiredSeconds int) (tokenString string) 
```

# 压力测试

自己使用jmeter进行压力测试

使用并发测试进行了两组100线程和1000线程。

但是自己在测试中发现，相同的条件多次测试，结果却有较大差异。应该是使用自己的电脑可能会受到相关进程影响，导致网络不稳定，自己希望试一试部署到云服务器上，在测试一下。

测试结果在文件中，虽然结果又是不稳定，但是仍然是使用redis的程序TPS值较高。



# API文档

```go
localhost:8080/user/register
	username := r.GetString("username")
	password := r.GetString("password")
	repassword := r.GetString("repassword")
	email := r.GetString("email")
	
localhost:8080/user/login
	username := u.GetString("username")
	password := u.GetString("password")
	
localhost:8080/user/verify
	email := r.GetString("email")
	code, _ := r.GetInt("code") //用户给的
	username := r.GetString("username")
	password := r.GetString("password")

localhost:8080/user/editpass
	username := r.GetString("username")
	password := r.GetString("password")
	repassword := r.GetString("repassword")
	
localhost:8080/post
PUT：
	postid, _ := o.GetInt("PostId")
	title := o.GetString("Title")
	content := o.GetString("Content")
DELETE：
	postid, _ := o.GetInt("PostId")
POST：
	title := o.GetString("Title")
	content := o.GetString("Content")

localhost:8080/post/page
GET ?Page=num
	page, err := o.GetInt("Page")

localhost:8080/post/pageanduser
GET ?Page=num
	page, err := o.GetInt("Page")


localhost:8080/comment
GET: ?Page=num&PostId=id
	page, err := o.GetInt("Page")
	postid, _ := o.GetInt("PostId")
POST:
	postid, _ := o.GetInt("PostId")
	content := o.GetString("Content")

DELETE:
	commentid, _ := o.GetInt("CommentId")

PUT:
	commentid, _ := o.GetInt("CommentId")
	content := o.GetString("Content")

```

# 实现的功能

帖子和评论的增，删，查，改。查看不需要登录。

​	返回值均为json，分页返回。

用户登录，注册，修改密码

​	包含邮箱验证码，JWT鉴权（放在cookie中）。

数据采用mysql进行储存。

实现了使用redis储存帖子和评论，设置了过期时间，查找更加快捷。



# 该程序的不足

## 没有做到mysql和redis的缓存一致性

由于时间原因，自己没有再去添加这个功能，导致msyql修改后，redis中储存的数据没有修改。

## 无法预防CSRF攻击

JWT放置在cookie中无法预防，自己查看了一些资料，发现实现预防CSRF有些困难，于是放弃。

如一下回答

[JWT + cookies + HTTPS + CSRF - Stack Overflow](https://stackoverflow.com/questions/35313384/jwt-cookies-https-csrf)

## 